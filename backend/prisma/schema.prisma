// This tells Prisma how to generate the client
generator client {
  provider = "prisma-client-js"
}

// This tells Prisma how to connect to your database
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Role enum - defines user types
enum Role {
  TEACHER
  STUDENT
  ADMIN
}

// Subscription Plan Types
enum PlanType {
  FREE
  PREMIUM
}

// Subscription Status
enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  TRIALING
  INCOMPLETE
}

// Payment Status
enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
}

// Establishment model - represents schools or institutions
model Establishment {
  id    String @id @default(uuid())
  name  String @unique
  shareToken       String?   @unique
  shareTokenExpiry DateTime?
  
  // Relations
  users            User[]
  billingInfo      BillingInfo?
}

// User model - represents teachers and students
model User {
  id                  String   @id @default(uuid())
  email               String   @unique
  lastname            String
  password            String?
  firstname           String
  profilePic          String?
  subscriptionId      String?
  establishmentId     String
  role                Role     @default(TEACHER)
  invitationToken     String?  @unique
  invitationExpiry    DateTime?
  resetPasswordToken  String?  @unique
  resetPasswordExpiry DateTime?
  googleId            String?  @unique
  provider            String?  @default("local")
  
  // Trial tracking
  trialEndDate        DateTime?
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  reviews             Review[]
  subscription        Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  establishment       Establishment @relation(fields: [establishmentId], references: [id])
  classes             Class[]
  teacher             Teacher?
  enrollments         Enrollment[]
}

model Subscription {
  id        String   @id @default(uuid())
  planType              PlanType            @default(FREE)
  status                SubscriptionStatus  @default(TRIALING)
  numberOfClasses       Int?                // Number of classes for premium plan
  isAnnual              Boolean             @default(false)
  
  // Stripe integration
  stripeCustomerId      String?             @unique
  stripeSubscriptionId  String?             @unique
  stripePriceId         String?
  stripeCurrentPeriodEnd DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users User[]
  payments              Payment[]
}

model Teacher {
  id        String   @id @default(uuid())
  userId    String?  @unique
  firstname String
  lastname  String
  bio       String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user    User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  lessons Lesson[]
}

// Class model - represents a class/course
model Class {
  id           String   @id @default(uuid())
  name         String
  description  String?
  academicYear String
  gradeLevel   String
  isActive     Boolean  @default(true)
  teacherId    String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  subjects     Subject[]
  reviewForms  ReviewForm[]

  // Relations
  teacher User      @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  enrollments Enrollment[]
  lessons  Lesson[]
}

model Enrollment {
  id        String   @id @default(uuid())
  classId   String
  studentId String
  createdAt DateTime @default(now())

  // Relations
  class   Class @relation(fields: [classId], references: [id], onDelete: Cascade)
  student User  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([classId, studentId])
}

model Subject {
  id                String    @id @default(uuid())
  name              String    // Matiere_nom
  instructorName    String?   // Intervenant_nom
  instructorEmail   String?   // Intervenant_email
  firstLessonDate   DateTime? // Date_premier_cours
  lastLessonDate    DateTime? // Date_dernier_cours
  classId           String
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Review invitation tracking
  duringFormSentAt  DateTime? // Sent date of "during the course" review form
  afterFormSentAt   DateTime? // Sent date of "after the course" review form

  // Link to review Forms
  duringFormId      String?
  afterFormId       String?

  // Relations
  class             Class      @relation(fields: [classId], references: [id], onDelete: Cascade)
  reviewForms       ReviewForm[]
  duringForm        ReviewForm? @relation("SubjectDuringForm", fields: [duringFormId], references: [id], onDelete: SetNull)
  afterForm         ReviewForm? @relation("SubjectAfterForm", fields: [afterFormId], references: [id], onDelete: SetNull)

  @@index([classId])
}

model Lesson {
  id          String   @id @default(uuid())
  title       String
  description String?
  classId     String
  teacherId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  class   Class   @relation(fields: [classId], references: [id], onDelete: Cascade)
  teacher Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@index([teacherId])
  // Relations
  @@index([classId])
}

// Contact model - represents contact form submissions
model Contact {
  id           String   @id @default(uuid())
  organization String
  lastName     String
  firstName    String
  email        String
  phone        String?
  classCount   Int
  message      String?
  wantsCallback Boolean @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([email])
}

// Review Form Template (created by teachers)
model ReviewForm {
  id          String   @id @default(uuid())
  title       String   // e.g., "Évaluation durant le cours"
  type        ReviewFormType // DURING_CLASS or AFTER_CLASS
  classId     String?
  subjectId   String?  // Optional: specific to a subject
  isActive    Boolean  @default(true)
  publicLink  String?  @unique @default(uuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  class       Class?    @relation(fields: [classId], references: [id], onDelete: Cascade)
  subject     Subject? @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  fields      ReviewFormField[]
  reviews     Review[]

  // Subjects that use this form
  subjectsUsingDuring Subject[] @relation("SubjectDuringForm")
  subjectsUsingAfter  Subject[] @relation("SubjectAfterForm")

  @@index([classId])
  @@index([subjectId])
}

enum ReviewFormType {
  DURING_CLASS
  AFTER_CLASS
}

// Form Fields (stars, radio, checkbox, textarea)
model ReviewFormField {
  id          String   @id @default(uuid())
  formId      String
  label       String   // e.g., "Comment évaluez-vous le cours ?"
  type        FieldType
  required    Boolean  @default(false)
  options     Json?    // For radio/checkbox: ["Excellent", "Bon", "Moyen", "Faible"]
  order       Int      // Display order
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  form        ReviewForm @relation(fields: [formId], references: [id], onDelete: Cascade)
  responses   ReviewResponse[]

  @@index([formId])
}

enum FieldType {
  STARS       // 1-5 stars rating
  RADIO       // Single choice
  CHECKBOX    // Multiple choices
  TEXTAREA    // Free text
}

// Student Review Submission
model Review {
  id          String   @id @default(uuid())
  formId      String
  studentId   String?  // Optional: anonymous reviews allowed
  sessionId   String?  // Track anonymous users
  publicLink  String   @unique @default(uuid()) // UUID for public access
  submittedAt DateTime @default(now())
  ipAddress   String?  // For spam prevention

  // Relations
  form        ReviewForm @relation(fields: [formId], references: [id], onDelete: Cascade)
  student     User?      @relation(fields: [studentId], references: [id], onDelete: SetNull)
  responses   ReviewResponse[]

  @@index([formId])
  @@index([studentId])
}

// Individual Field Responses
model ReviewResponse {
  id          String   @id @default(uuid())
  reviewId    String
  fieldId     String
  value       Json     // Stores: number (stars), string (radio/textarea), string[] (checkbox)
  createdAt   DateTime @default(now())

  // Relations
  review      Review    @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  field       ReviewFormField @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  @@index([reviewId])
  @@index([fieldId])
}

// Billing Information - linked to Establishment (Admin account)
model BillingInfo {
  id                String        @id @default(uuid())
  establishmentId   String        @unique
  
  // Company/Organization info
  lastname        String
  firstname       String
  TVAnumber       String
  SIRETnumber     String
  
  // Billing address
  address      String
  additionalAddress      String?
  city              String
  postalCode        String
  country           String        @default("FR")
  
  // Contact
  billingEmail      String
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  // Relations
  establishment     Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  
  @@index([establishmentId])
}

// Payment History
model Payment {
  id                String        @id @default(uuid())
  subscriptionId    String
  amount            Float         // Amount in euros
  currency          String        @default("EUR")
  status            PaymentStatus @default(PENDING)
  
  // Stripe integration
  stripePaymentId   String?       @unique
  stripeInvoiceId   String?       @unique
  stripeInvoiceUrl  String?
  
  // Payment details
  description       String?
  paidAt            DateTime?
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  // Relations
  subscription      Subscription  @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  
  @@index([subscriptionId])
  @@index([status])
}
